#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å GitHub
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./poll-sync.sh [–∏–Ω—Ç–µ—Ä–≤–∞–ª_–≤_—Å–µ–∫—É–Ω–¥–∞—Ö]
# –ü—Ä–∏–º–µ—Ä: ./poll-sync.sh 60  (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥)

INTERVAL=${1:-30}  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 30 —Å–µ–∫—É–Ω–¥

echo "üîÑ –ó–∞–ø—É—Å–∫–∞—é –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é..."
echo "‚è±Ô∏è  –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏: $INTERVAL —Å–µ–∫—É–Ω–¥"
echo "üìå –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç auto-sync.sh —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -f "auto-sync.sh" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω —Å–∫—Ä–∏–ø—Ç auto-sync.sh"
    exit 1
fi

# –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x auto-sync.sh

# –ù–∞—á–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
echo "üîÑ [$(date '+%H:%M:%S')] –ù–∞—á–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è..."
./auto-sync.sh

echo ""
echo "‚è≥ –ë—É–¥—É –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ $INTERVAL —Å–µ–∫—É–Ω–¥..."
echo ""

# –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏
while true; do
    sleep $INTERVAL
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ GitHub
    git fetch origin --quiet
    
    LOCAL=$(git rev-parse @ 2>/dev/null)
    REMOTE=$(git rev-parse @{u} 2>/dev/null || echo "")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    HAS_REMOTE_CHANGES=false
    HAS_LOCAL_CHANGES=false
    
    if [ -n "$REMOTE" ] && [ "$LOCAL" != "$REMOTE" ]; then
        HAS_REMOTE_CHANGES=true
    fi
    
    if [ -n "$(git status --porcelain)" ]; then
        HAS_LOCAL_CHANGES=true
    fi
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∑–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
    if [ "$HAS_REMOTE_CHANGES" = true ] || [ "$HAS_LOCAL_CHANGES" = true ]; then
        echo ""
        echo "üîÑ [$(date '+%H:%M:%S')] –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é..."
        ./auto-sync.sh
        echo ""
        echo "‚è≥ –°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ $INTERVAL —Å–µ–∫—É–Ω–¥..."
    else
        # –¢–∏—Ö–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–≤–æ–¥–∏–º, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç
        :
    fi
done

