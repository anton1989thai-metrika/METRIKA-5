#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Next.js dev-—Å–µ—Ä–≤–µ—Ä–∞ —Å ngrok –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./start-dev-with-ngrok.sh

PORT=3000

echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é Next.js dev-—Å–µ—Ä–≤–µ—Ä –∏ ngrok..."
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "package.json" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ METRIKA-5"
    exit 1
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
cleanup() {
    echo ""
    echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø—Ä–æ—Ü–µ—Å—Å—ã..."
    kill $NEXT_PID $NGROK_PID 2>/dev/null
    exit
}

trap cleanup SIGINT SIGTERM

# –ó–∞–ø—É—Å–∫–∞–µ–º Next.js dev-—Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–µ
echo "üì¶ –ó–∞–ø—É—Å–∫–∞—é Next.js –Ω–∞ –ø–æ—Ä—Ç—É $PORT..."
npm run dev &
NEXT_PID=$!

# –ñ–¥–µ–º –ø–æ–∫–∞ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
echo "‚è≥ –ñ–¥—É –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
if ! curl -s http://localhost:$PORT > /dev/null; then
    echo "‚ö†Ô∏è  –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—à–∏–±–∫–∏ –≤—ã—à–µ."
    kill $NEXT_PID 2>/dev/null
    exit 1
fi

echo "‚úÖ Next.js —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω!"
echo ""

# –ó–∞–ø—É—Å–∫–∞–µ–º ngrok
echo "üåê –ó–∞–ø—É—Å–∫–∞—é ngrok —Ç—É–Ω–Ω–µ–ª—å..."
ngrok http $PORT &
NGROK_PID=$!

echo ""
echo "‚úÖ –í—Å—ë –∑–∞–ø—É—â–µ–Ω–æ!"
echo ""
echo "üìç –õ–æ–∫–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å: http://localhost:$PORT"
echo "üåê –ü—É–±–ª–∏—á–Ω—ã–π –∞–¥—Ä–µ—Å (ngrok): http://127.0.0.1:4040"
echo ""
echo "‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—ë: Ctrl+C"
echo ""

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
wait

