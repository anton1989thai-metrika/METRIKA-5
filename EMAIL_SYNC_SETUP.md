# Настройка получения писем на ваш сайт

Чтобы письма приходили на ваш сайт вместо Яндекс, нужно выполнить несколько шагов.

## Вариант 1: Использование существующего почтового сервера (Яндекс) через IMAP

Это самый простой способ - мы будем получать письма с Яндекс через IMAP и сохранять их в вашу базу данных.

### Шаг 1: Настройте IMAP в .env

Откройте файл `.env` и укажите настройки IMAP для вашего почтового ящика:

```env
IMAP_HOST="imap.yandex.ru"
IMAP_PORT="993"
IMAP_USER="reg@metrika.direct"
IMAP_PASS="ваш_пароль_от_яндекс_почты"
```

### Шаг 2: Включите IMAP в Яндекс.Почте

1. Зайдите в настройки Яндекс.Почты: https://mail.yandex.ru
2. Перейдите в "Почтовые программы"
3. Включите "С сервера imap.yandex.ru по протоколу IMAP"
4. Создайте пароль для приложения (если требуется)

### Шаг 3: Синхронизация писем

#### Ручная синхронизация:

Откройте в браузере или через curl:
```
http://localhost:3000/api/emails/sync
```

Или используйте кнопку "Синхронизировать" в интерфейсе (если добавите).

#### Автоматическая синхронизация:

**Вариант A: Через API endpoint (рекомендуется)**

Создайте cron job на вашем сервере:
```bash
# Синхронизация каждые 5 минут
*/5 * * * * curl -X POST http://localhost:3000/api/emails/sync
```

**Вариант B: Через Node.js скрипт**

Установите `node-cron`:
```bash
npm install node-cron
```

Создайте файл `scripts/sync-emails.ts`:
```typescript
import cron from 'node-cron'
import { syncAllEmails } from '../src/lib/imap-sync'

// Синхронизация каждые 5 минут
cron.schedule('*/5 * * * *', async () => {
  console.log('Syncing emails...')
  await syncAllEmails()
})
```

Запустите:
```bash
npm run sync-emails
```

## Вариант 2: Собственный почтовый сервер (для production)

Если вы хотите полностью независимую почту, нужно настроить собственный почтовый сервер.

### Шаг 1: Настройка DNS записей

В настройках домена `metrika.direct` у вашего регистратора добавьте:

1. **MX запись** (указывает на почтовый сервер):
   ```
   Тип: MX
   Имя: @ (или metrika.direct)
   Значение: mail.metrika.direct (или IP вашего сервера)
   Приоритет: 10
   ```

2. **A запись** для почтового сервера:
   ```
   Тип: A
   Имя: mail
   Значение: IP_адрес_вашего_сервера
   ```

3. **SPF запись** (защита от спама):
   ```
   Тип: TXT
   Имя: @
   Значение: v=spf1 mx ~all
   ```

4. **DKIM запись** (подпись писем):
   ```
   Тип: TXT
   Имя: mail._domainkey
   Значение: (сгенерируйте ключ на сервере)
   ```

5. **DMARC запись**:
   ```
   Тип: TXT
   Имя: _dmarc
   Значение: v=DMARC1; p=none; rua=mailto:dmarc@metrika.direct
   ```

### Шаг 2: Установка почтового сервера

На вашем VPS сервере установите почтовый сервер:

**Для Ubuntu/Debian:**
```bash
sudo apt-get update
sudo apt-get install postfix dovecot-core dovecot-imapd
```

**Для CentOS/RHEL:**
```bash
sudo yum install postfix dovecot
```

### Шаг 3: Настройка Postfix и Dovecot

Это сложная настройка, требующая конфигурации множества файлов. Рекомендую использовать готовые решения:

- **Mail-in-a-Box**: https://mailinabox.email/ (самый простой)
- **iRedMail**: https://www.iredmail.org/ (полнофункциональный)
- **Poste.io**: https://poste.io/ (веб-интерфейс)

### Шаг 4: Обновление .env

После настройки сервера обновите `.env`:
```env
IMAP_HOST="mail.metrika.direct"
IMAP_PORT="993"
IMAP_USER="reg@metrika.direct"
IMAP_PASS="пароль_от_почтового_сервера"
```

## Рекомендации

1. **Для начала**: Используйте Вариант 1 (IMAP с Яндекс) - это быстро и не требует настройки сервера
2. **Для production**: Настройте собственный почтовый сервер (Вариант 2) для полной независимости
3. **Безопасность**: Используйте сильные пароли и двухфакторную аутентификацию
4. **Резервное копирование**: Регулярно делайте бэкап базы данных

## Тестирование

После настройки:

1. Отправьте тестовое письмо на `reg@metrika.direct`
2. Запустите синхронизацию: `curl -X POST http://localhost:3000/api/emails/sync`
3. Проверьте в интерфейсе `/email` - письмо должно появиться

## Устранение проблем

- **Ошибка подключения IMAP**: Проверьте настройки в `.env` и доступность сервера
- **Письма не появляются**: Проверьте логи сервера и убедитесь, что синхронизация запускается
- **Проблемы с DNS**: Используйте инструменты типа `dig` или `nslookup` для проверки MX записей

