# Инструкция: Выполнить на сервере

## Быстрый запуск

1. Загрузите скрипт на сервер:
```bash
scp scripts/complete-mail-fix.sh root@72.62.72.196:/root/
```

2. Подключитесь к серверу:
```bash
ssh root@72.62.72.196
```

3. Запустите скрипт:
```bash
cd /root
chmod +x complete-mail-fix.sh
sudo ./complete-mail-fix.sh
```

## Что делает скрипт

Скрипт автоматически:

1. **Анализирует текущее состояние:**
   - Конфигурацию Dovecot (doveconf -n)
   - Конфигурацию Postfix (postconf -n)
   - Файлы auth конфигурации
   - Пользователя info и его директории
   - LMTP сокет
   - Логи на наличие ошибок

2. **Исправляет конфигурацию:**
   - Настраивает `userdb driver = passwd` для системных пользователей
   - Настраивает `mail_location = mbox:~/mail:INBOX=/var/mail/%u`
   - Настраивает `service lmtp` с `user = root`
   - Настраивает `service auth` с `user = root`
   - Убирает конфликт `mydestination`/`virtual_mailbox_domains`
   - Убирает `virtual_mailbox_domains` (используем системных пользователей)
   - Настраивает `local_transport = virtual`
   - Создает почтовые директории для пользователя info

3. **Проверяет конфигурацию:**
   - `doveconf -n` - проверка Dovecot
   - `postconf -n` - проверка Postfix

4. **Перезапускает сервисы:**
   - `systemctl restart dovecot`
   - `systemctl restart postfix`

5. **Тестирует доставку:**
   - Отправляет тестовое письмо: `echo "test" | sendmail info@metrika.direct`
   - Проверяет очередь Postfix
   - Проверяет доставку в `/var/mail/info`
   - Анализирует логи

6. **Создает отчет:**
   - Полный отчет сохраняется в `/root/mail-fix-report-*.txt`
   - Резервная копия конфигурации в `/root/dovecot-postfix-backup-*/`

## Результат

После выполнения скрипта вы получите:
- ✅ Полный отчет о всех изменениях
- ✅ Резервную копию конфигурации
- ✅ Результат тестирования доставки
- ✅ Краткую сводку изменений

## Если скрипт не может подключиться автоматически

Выполните команды вручную на сервере - скрипт содержит все необходимые исправления.

