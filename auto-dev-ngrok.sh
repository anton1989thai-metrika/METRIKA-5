#!/bin/bash

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è GitHub ‚Üí –ª–æ–∫–∞–ª—å–Ω–æ ‚Üí dev-—Å–µ—Ä–≤–µ—Ä ‚Üí ngrok
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å GitHub —Å—Ä–∞–∑—É –ø–æ–ø–∞–¥–∞—é—Ç –Ω–∞ ngrok

PROJECT_DIR="$(pwd)"
PORT=3000

echo "üîÑ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é cache GitHub ‚Üí ngrok..."

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞ dev-—Å–µ—Ä–≤–µ—Ä–∞
ensure_dev_server() {
    if ! pgrep -f "next dev" > /dev/null; then
        echo "üì¶ –ó–∞–ø—É—Å–∫–∞—é Next.js dev-—Å–µ—Ä–≤–µ—Ä..."
        cd "$PROJECT_DIR"
        npm run dev > /tmp/nextjs-dev.log 2>&1 &
        sleep 5
        echo "‚úÖ Dev-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω"
    else
        echo "‚úÖ Dev-—Å–µ—Ä–≤–µ—Ä —É–∂–µ –∑–∞–ø—É—â–µ–Ω"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞ ngrok
ensure_ngrok() {
    if ! pgrep -f "ngrok http" > /dev/null; then
        echo "üåê –ó–∞–ø—É—Å–∫–∞—é ngrok..."
        cd "$PROJECT_DIR"
        ngrok http $PORT > /tmp/ngrok.log 2>&1 &
        sleep 3
        echo "‚úÖ Ngrok –∑–∞–ø—É—â–µ–Ω"
    else
        echo "‚úÖ Ngrok —É–∂–µ –∑–∞–ø—É—â–µ–Ω"
    fi
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∞–¥—Ä–µ—Å
    sleep 2
    PUBLIC_URL=$(curl -s http://127.0.0.1:4040/api/tunnels 2>/dev/null | grep -o '"public_url":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
    if [ -n "$PUBLIC_URL" ]; then
        echo "üåê –ü—É–±–ª–∏—á–Ω—ã–π –∞–¥—Ä–µ—Å: $PUBLIC_URL"
        echo "$PUBLIC_URL" > /tmp/ngrok-url.txt
    fi
}

# –§—É–Ω–∫—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å GitHub
sync_from_github() {
    cd "$PROJECT_DIR"
    
    echo "üì• –ü—Ä–æ–≤–µ—Ä—è—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ GitHub..."
    git fetch origin --quiet
    
    LOCAL=$(git rev-parse @ 2>/dev/null)
    REMOTE=$(git rev-parse @{u} 2>/dev/null || echo "")
    
    if [ -n "$REMOTE" ] && [ "$LOCAL" != "$REMOTE" ]; then
        echo "üì• –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ GitHub. –û–±–Ω–æ–≤–ª—è—é..."
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
        if [ -n "$(git status --porcelain)" ]; then
            echo "‚ö†Ô∏è  –°–æ—Ö—Ä–∞–Ω—è—é –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
            git stash push -m "Auto-sync: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ pull $(date '+%Y-%m-%d %H:%M:%S')"
        fi
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        git pull origin main --no-rebase
        
        if [ $? -eq 0 ]; then
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å GitHub"
            
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –µ—Å–ª–∏ –±—ã–ª–∏
            git stash pop 2>/dev/null || echo ""
            
            # Next.js –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤ (hot reload)
            echo "üîÑ Dev-—Å–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è (hot reload)"
            return 0
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
            return 1
        fi
    else
        echo "‚ÑπÔ∏è  –ù–µ—Ç –Ω–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ GitHub"
        return 0
    fi
}

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
main() {
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é GitHub ‚Üí ngrok"
    echo "üìç –ü—Ä–æ–µ–∫—Ç: $PROJECT_DIR"
    echo ""
    
    # –í–ê–ñ–ù–û: –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å GitHub –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    # –≠—Ç–æ –∑–∞–≥—Ä—É–∑–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Å–¥–µ–ª–∞–Ω–Ω—ã–µ –ø–æ–∫–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä –±—ã–ª –≤—ã–∫–ª—é—á–µ–Ω
    echo "üîÑ –ü—Ä–æ–≤–µ—Ä—è—é –∏ –∑–∞–≥—Ä—É–∂–∞—é –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å GitHub (–ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–∏—Å—Ç–µ–º—ã)..."
    sync_from_github
    
    # –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ dev-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
    ensure_dev_server
    
    # –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ ngrok –∑–∞–ø—É—â–µ–Ω
    ensure_ngrok
    
    echo ""
    echo "‚úÖ –í—Å—ë –∑–∞–ø—É—â–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ!"
    echo "üîÑ –ë—É–¥—É –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ GitHub –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥..."
    echo "‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: Ctrl+C"
    echo ""
    
    # –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    while true; do
        sleep 30
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ GitHub
        if sync_from_github; then
            # –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç
            ensure_dev_server
            ensure_ngrok
        fi
    done
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤
trap 'echo ""; echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é..."; exit 0' SIGINT SIGTERM

# –ó–∞–ø—É—Å–∫
main

